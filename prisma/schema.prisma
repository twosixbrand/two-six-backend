// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// Tablas de Autenticación y Logs
// -----------------------------------------------------

model ErrorLog {
  id             Int      @id @default(autoincrement())
  message        String
  stack          String?
  componentStack String?  @map("component_stack")
  app            String?  @db.VarChar(4)
  page           String?  @db.VarChar(50)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime? @updatedAt @map("updated_at")

  @@map("log_error")
}

model UserApp {
  id           Int        @id @default(autoincrement()) @map("id_user_app")
  name         String
  login        String     @unique
  email        String     @unique
  phone        String
  password     String?
  otp          String?
  otpExpiresAt DateTime?  @map("otp_expires_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime?   @updatedAt @map("updated_at")
  userRoles    UserRole[]

  @@map("user_app")
}

model Role {
  id          Int        @id @default(autoincrement()) @map("id_role")
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime?   @updatedAt @map("updated_at")
  userRoles   UserRole[]

  @@map("role")
}

model UserRole {
  id          Int      @id @default(autoincrement())
  user        UserApp  @relation(fields: [id_user_app], references: [id])
  id_user_app Int      @map("id_user_app")
  role        Role     @relation(fields: [id_role], references: [id])
  id_role     Int      @map("id_role")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")

  @@map("user_role")
}

// -----------------------------------------------------
// Tablas de Inventario y Diseño
// -----------------------------------------------------

model Provider {
  id             String   @id @map("nit")
  company_name   String   @map("company_name")
  email          String   @unique
  phone          String
  account_number String   @map("account_number")
  account_type   String   @map("account_type")
  bank_name      String   @map("bank_name")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime? @updatedAt @map("updated_at")
  designProviders DesignProvider[] // Nueva relación con DesignProvider

  @@map("provider")
}

model YearProduction {
  id          String   @id @db.Char(2)
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")
  collections Collection[]

  @@map("year_production")
}

model Season {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime?    @updatedAt @map("updated_at")
  collections Collection[]

  @@map("season")
}

model Collection {
  id          Int      @id @default(autoincrement())
  name        String
  season      Season   @relation(fields: [id_season], references: [id])
  id_season   Int      @map("id_season")
  yearProduction     YearProduction @relation(fields: [id_year_production], references: [id])
  id_year_production  String         @map("id_year_production") @db.Char(2)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")
  designs     Design[]

  @@map("collection")
}

model TypeClothing {
  id        String     @id @db.Char(2)
  name      String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime?   @updatedAt @map("updated_at")
  clothing  Clothing[]

  @@map("type_clothing")
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime?   @updatedAt @map("updated_at")
  clothing  Clothing[]

  @@map("category")
}

enum Gender {
  MASCULINO
  FEMENINO
  UNISEX
}

model Clothing {
  id               Int          @id @default(autoincrement())
  typeClothing     TypeClothing @relation(fields: [id_type_clothing], references: [id])
  id_type_clothing String       @map("id_type_clothing") @db.Char(2)
  category         Category     @relation(fields: [id_category], references: [id])
  id_category      Int          @map("id_category")
  name             String
  gender           Gender
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime?     @updatedAt @map("updated_at")
  designs          Design[]

  @@map("clothing")
}

model Color {
  id             Int              @id @default(autoincrement())
  name           String
  hex            String
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime?         @updatedAt @map("updated_at")
  designClothing DesignClothing[]

  @@map("color")
}

model Size {
  id             Int              @id @default(autoincrement())
  name           String
  description    String?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime?         @updatedAt @map("updated_at")
  designClothing DesignClothing[]

  @@map("size")
}

model Design {
  id                 Int              @id @default(autoincrement())
  id_collection      Int              @map("id_collection")
  collection         Collection       @relation(fields: [id_collection], references: [id])
  id_clothing        Int              @map("id_clothing")
  clothing           Clothing         @relation(fields: [id_clothing], references: [id])
  reference          String
  manufactured_cost  Float
  description        String?
  quantity           Int
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime?         @updatedAt @map("updated_at")
  designClothing     DesignClothing[]
  designProviders    DesignProvider[] // Nueva relación con DesignProvider

  @@map("design")
}

// Nueva tabla para el tipo de producción
model ProductionType {
  id                 Int      @id @default(autoincrement()) @map("id_production_type")
  name               String
  creationDate       DateTime @default(now()) @map("created_at")
  updateDate         DateTime @updatedAt @map("updated_at")
  designProviders    DesignProvider[]

  @@map("production_type")
}

// Nueva tabla intermedia para la relación entre Design y Provider
model DesignProvider {
  id                 Int              @id @default(autoincrement())
  design             Design           @relation(fields: [id_design], references: [id])
  id_design          Int              @map("id_design")
  provider           Provider         @relation(fields: [id_provider], references: [id])
  id_provider        String           @map("id_provider")
  productionType     ProductionType   @relation(fields: [id_production_type], references: [id])
  id_production_type Int              @map("id_production_type")
  start_date         DateTime?
  end_date           DateTime?
  price              Decimal
  rating             Int?
  comment            String?
  creationDate       DateTime @default(now()) @map("created_at")
  updateDate         DateTime? @updatedAt @map("updated_at")

  @@map("design_provider")
}

model DesignClothing {
  id                      Int      @id @default(autoincrement())
  color                   Color    @relation(fields: [id_color], references: [id])
  id_color                Int      @map("id_color")
  size                    Size     @relation(fields: [id_size], references: [id])
  id_size                 Int      @map("id_size")
  design                  Design   @relation(fields: [id_design], references: [id])
  id_design               Int      @map("id_design")
  quantity_produced       Int
  quantity_available      Int
  quantity_sold           Int
  quantity_on_consignment Int
  quantity_under_warranty Int      @default(0) @map("quantity_under_warranty")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime? @updatedAt @map("updated_at")
  product                 Product? // Relación 1-a-1 con Product
  stock                   Stock? // Relación 1-a-1 con Stock

  @@map("design_clothing")
}

model Stock {
  id                   Int            @id @default(autoincrement())
  designClothing       DesignClothing @relation(fields: [id_design_clothing], references: [id])
  id_design_clothing   Int            @unique @map("id_design_clothing")
  current_quantity     Int
  available_quantity   Int
  sold_quantity        Int
  consignment_quantity Int
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime?       @updatedAt @map("updated_at")

  @@map("stock")
}

// -----------------------------------------------------
// Tablas de Producto (Tienda) y Clientes
// -----------------------------------------------------

model Product {
  id                         Int            @id @default(autoincrement())
  designClothing             DesignClothing @relation(fields: [id_design_clothing], references: [id])
  id_design_clothing         Int            @unique @map("id_design_clothing")
  name                       String
  description                String
  sku                        String?
  price                      Float
  discount_price             Float?
  discount_percentage        Float?
  consecutive_number         String?
  image_url                  String?
  active                     Boolean
  is_outlet                  Boolean        @map("is_outlet")
  createdAt                  DateTime       @default(now()) @map("created_at")
  updatedAt                  DateTime?       @updatedAt @map("updated_at")
  orderItems                 OrderItem[]
  returnItems                ReturnItem[]
 

  @@map("product")
}

model Customer {
  id                     Int                @id @default(autoincrement())
  customerType           CustomerType       @relation(fields: [id_customer_type], references: [id])
  id_customer_type       Int                @map("id_customer_type")
  identificationType     IdentificationType @relation(fields: [id_identification_type], references: [id])
  id_identification_type Int                @map("id_identification_type")
  name                   String
  email                  String             @unique
  current_phone_number   String
  responsable_for_vat    Boolean
  shipping_address       String
  city                   String
  state                  String
  postal_code            String
  country                String
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime?           @updatedAt @map("updated_at")
  order                  Order[]
  returns                Returns[]
  payments               Payments[]

  @@map("customer")
}

model CustomerType {
  id        Int        @id @default(autoincrement())
  name      String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime?   @updatedAt @map("updated_at")
  customers Customer[]

  @@map("customer_type")
}

model IdentificationType {
  id        Int        @id @default(autoincrement())
  name      String
  code      String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime?   @updatedAt @map("updated_at")
  customers Customer[]

  @@map("identification_type")
}

// -----------------------------------------------------
// Tablas de Órdenes y Pagos
// -----------------------------------------------------

model Order {
  id               Int             @id @default(autoincrement()) @map("id_order")
  customer         Customer        @relation(fields: [id_customer], references: [id])
  id_customer      Int             @map("id_customer")
  order_date       DateTime
  status           String
  iva              Float
  shipping_cost    Float           @map("shipping_cost")
  total_payment    Float           @map("total_payment")
  purchase_date    DateTime        @map("purchase_date")
  is_paid          Boolean
  shipping_address String
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime?        @updatedAt @map("updated_at")
  orderItems       OrderItem[]
  returns          Returns[]
  shipments        Shipment[]
  dianEInvoicing   DianEInvoicing?
  payments         Payments[] // Relación añadida (no estaba explícita en el ERD pero es necesaria)

  @@map("order")
}

model OrderItem {
  id           Int           @id @default(autoincrement())
  order        Order         @relation(fields: [id_order], references: [id])
  id_order     Int           @map("id_order")
  product      Product       @relation(fields: [id_product], references: [id])
  id_product   Int           @map("id_product")
  product_name String
  size         String
  color        String
  quantity     Int
  unit_price   Float
  iva_item     Float    @map("iva_item")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime?      @updatedAt @map("updated_at")
  returnItems  ReturnItem[]

  @@map("order_item")
}

model Returns {
  id              Int           @id @default(autoincrement())
  order           Order         @relation(fields: [id_order], references: [id])
  id_order        Int           @map("id_order")
  customer        Customer      @relation(fields: [id_customer], references: [id])
  id_customer     Int           @map("id_customer")
  type            String
  reason          String
  status          String
  request_date    DateTime
  refund_amount   Float
  shipping_method String
  tracking        String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime?      @updatedAt @map("updated_at")
  returnItems     ReturnItem[]

  @@map("returns")
}

model ReturnItem {
  id            Int        @id @default(autoincrement())
  return        Returns    @relation(fields: [id_return], references: [id])
  id_return     Int        @map("id_return") 
  orderItem     OrderItem @relation(fields: [id_order_item], references: [id])
  id_order_item Int        @map("id_order_item")
  product       Product    @relation(fields: [id_product], references: [id])
  id_product    Int        @map("id_product")
  quantity      Int
  reason_return String
  condition     String
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime?   @updatedAt @map("updated_at")

  @@map("return_item")
}

model PaymentMethod {
  id        Int        @id @default(autoincrement())
  name      String
  enabled   Boolean
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime?   @updatedAt @map("updated_at")
  payments  Payments[]

  @@map("payment_method")
}

model Payments {
  id                    Int           @id @default(autoincrement())
  order                 Order         @relation(fields: [id_order], references: [id])
  id_order              Int           @map("id_order")
  customer              Customer      @relation(fields: [id_customer], references: [id])
  id_customer           Int           @map("id_customer")
  paymentMethod         PaymentMethod @relation(fields: [id_payment_method], references: [id])
  id_payment_method     Int           @map("id_payment_method")
  status                String
  transaction_date      DateTime
  transaction_reference String
  amount                Float
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime?      @updatedAt @map("updated_at")

  @@map("payments")
}

model DianEInvoicing {
  id              Int      @id @default(autoincrement())
  order           Order    @relation(fields: [id_order], references: [id])
  id_order        Int      @unique @map("id_order")
  cufe_code       String
  qr_code         String
  document_number String
  issue_date      DateTime
  due_date        DateTime
  status          String
  url_pdf         String
  url_xml         String
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime? @updatedAt @map("updated_at")

  @@map("dian_e_invoicing")
}

// -----------------------------------------------------
// Tablas de Envíos
// -----------------------------------------------------

model ShippingProvider {
  id                Int            @id @default(autoincrement())
  name              String
  set_tracking_base String
  active            Boolean
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime?       @updatedAt @map("updated_at")
  shipments         Shipment[]
  shipmentRates     ShipmentRate[]

  @@map("shipping_provider")
}

model ShipmentRate {
  id                       Int              @id @default(autoincrement())
  shippingProvider         ShippingProvider @relation(fields: [id_shipping_provider], references: [id])
  id_shipping_provider     Int              @map("id_shipping_provider")
  destination_zone         String
  weight_unit              String
  base_cost                Float
  cost_per_additional_unit Float
  estimated_delivery_time  String
  shipping_code            String
  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime?         @updatedAt @map("updated_at")

  @@map("shipment_rate")
}

model Shipment {
  id                      Int               @id @default(autoincrement())
  order                   Order             @relation(fields: [id_order], references: [id])
  id_order                Int               @map("id_order")
  shippingProvider        ShippingProvider  @relation(fields: [id_shipping_provider], references: [id])
  id_shipping_provider    Int               @map("id_shipping_provider")
  guide_number            String
  status                  String
  estimated_delivery_date DateTime
  delivery_date           DateTime?
  id_tracking             String?
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime?          @updatedAt @map("updated_at")
  trackingHistory         TrackingHistory[]

  @@map("shipment")
}

model TrackingHistory {
  id            Int      @id @default(autoincrement())
  shipment      Shipment @relation(fields: [id_shipment], references: [id])
  id_shipment   Int      @map("id_shipment")
  status        String
  update_date   DateTime
  location      String
  provider_code String
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime? @updatedAt @map("updated_at")

  @@map("tracking_history")
}
